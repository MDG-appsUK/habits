<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Habits</title>

  <!-- PWA -->
  <link rel="manifest" href="/habits/manifest.json">
  <meta name="theme-color" content="#121212">

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Habits">
  <link rel="apple-touch-icon" href="/habits/icons/icon-192.png">

  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      background: #0f0f10;
      color: #eaeaea;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: 16px 16px 90px;
    }
    .wrap { max-width: 720px; margin: 0 auto; }

    h1 { font-size: 20px; margin: 0; }
    .sub { font-size: 12px; color: #bdbdc7; line-height: 1.35; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    button, input {
      background: #101013;
      color: #eaeaea;
      border: 1px solid #2c2c35;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
    }
    button { background: #1f1f26; cursor: pointer; }

    .card {
      background: #17171a;
      border: 1px solid #26262c;
      border-radius: 18px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 8px 30px rgba(0,0,0,.35);
    }

    .habitList { display: grid; gap: 10px; }

    .habitRow {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      background: #17171a;
      border: 1px solid #26262c;
      border-radius: 16px;
      padding: 12px;
    }

    .habitName {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      min-width: 0;
    }

    .nameText {
      font-weight: 700;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pill {
      font-size: 12px;
      border: 1px solid #2c2c35;
      padding: 2px 8px;
      border-radius: 999px;
      color: #bdbdc7;
      flex: 0 0 auto;
    }

    .weekGrid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      justify-items: center;
      align-items: center;
      min-width: 0;
    }

    .weekGrid .spacer {
      visibility: hidden;
    }

    .box {
      width: 100%;
      max-width: 54px;
      aspect-ratio: 1 / 1;
      border-radius: 10px;
      border: 1px solid #2c2c35;
      background: #0f0f10;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    /* Letter inside box (visible only when empty) */
    .box .label {
      font-size: 14px;
      font-weight: 800;
      color: #bdbdc7;
      letter-spacing: 0.5px;
    }

    /* Done hides letter by covering it */
    .box.done {
      background: var(--c);
      border-color: color-mix(in srgb, var(--c) 70%, #2c2c35);
    }
    .box.done .label { opacity: 0; }

    /* Rest hides letter too, with hatched pattern */
    .box.rest {
      background: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,.18) 0px,
        rgba(255,255,255,.18) 4px,
        rgba(255,255,255,.03) 4px,
        rgba(255,255,255,.03) 8px
      );
      border-color: #3a3a45;
    }
    .box.rest .label { opacity: 0; }

    .hint {
      margin-top: 10px;
      font-size: 12px;
      color: #bdbdc7;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="row" style="justify-content:space-between; margin-bottom:10px">
    <div>
      <h1>Habits</h1>
      <div class="sub" id="todayLine"></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <input id="newHabitName" placeholder="Add habit">
      <button id="addHabitBtn">Add</button>
    </div>
    <div class="hint">
      Tap a day: None → Done → Rest → None. Max 2 rest days per week.<br>
      Streaks count DONE days; REST pauses; NONE breaks.
    </div>
  </div>

  <div class="habitList" id="habitList"></div>

</div>

<script>
  const UK = "en-GB";
  const pad = n => String(n).padStart(2, "0");
  const toISO = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const fromISO = s => { const [y,m,d] = s.split("-").map(Number); return new Date(y, m-1, d); };
  const fmtUK = d => d.toLocaleDateString(UK);
  const addDays = (d,n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };

  const startOfWeek = d => {
    const x = new Date(d);
    x.setDate(x.getDate() - ((x.getDay() + 6) % 7)); // Monday start
    x.setHours(0,0,0,0);
    return x;
  };

  function makeId() {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  const STORAGE = "habits_data_v1";
  const now = new Date(); now.setHours(0,0,0,0);

  function load() {
    const raw = localStorage.getItem(STORAGE);
    if (raw) return JSON.parse(raw);

    const habits = [
      { id: makeId(), name: "Write",   color: "#7c5cff" },
      { id: makeId(), name: "Walk",    color: "#37d67a" },
      { id: makeId(), name: "Workout", color: "#ff7a59" },
      { id: makeId(), name: "Piano",   color: "#4aa3ff" }
    ];

    const entries = {};
    habits.forEach(h => entries[h.id] = {});
    const data = { habits, entries };
    localStorage.setItem(STORAGE, JSON.stringify(data));
    return data;
  }

  const data = load();

  function streak(hid) {
    let s = 0;
    let cur = new Date(now);
    while (true) {
      const v = data.entries[hid][toISO(cur)] || "none";
      if (v === "none") break;
      if (v === "done") s++;
      cur = addDays(cur, -1);
    }
    return s;
  }

  function restCount(hid, iso) {
    const s = startOfWeek(fromISO(iso));
    let c = 0;
    for (let i=0; i<7; i++) {
      if (data.entries[hid][toISO(addDays(s, i))] === "rest") c++;
    }
    return c;
  }

  function cycle(hid, iso) {
    const cur = data.entries[hid][iso] || "none";
    const next = (cur === "none") ? "done" : (cur === "done") ? "rest" : "none";
    if (next === "rest" && restCount(hid, iso) >= 2) return;

    if (next === "none") delete data.entries[hid][iso];
    else data.entries[hid][iso] = next;

    localStorage.setItem(STORAGE, JSON.stringify(data));
    render();
  }

  function render() {
    document.getElementById("todayLine").textContent =
      `Today: ${fmtUK(now)} • Week starts: ${fmtUK(startOfWeek(now))}`;

    const list = document.getElementById("habitList");
    list.innerHTML = "";

    const weekStart = startOfWeek(now);
    const weekDates = Array.from({length: 7}, (_, i) => addDays(weekStart, i));

    // Labels inside boxes: M T W T F S S
    const labels = ["M","T","W","T","F","S","S"];

    data.habits.forEach(h => {
      const row = document.createElement("div");
      row.className = "habitRow";

      const left = document.createElement("div");
      left.className = "habitName";
      left.innerHTML = `
        <span class="nameText">${h.name}</span>
        <span class="pill">${streak(h.id)}</span>
      `;

      const grid = document.createElement("div");
      grid.className = "weekGrid";

      // 2-row layout using a 4-col grid.
      // Top row: 0..3 (Mon..Thu)
      // Bottom row: 4..6 (Fri..Sun) + 1 spacer
      for (let i = 0; i < 7; i++) {
        const d = weekDates[i];
        const iso = toISO(d);
        const v = data.entries[h.id][iso] || "none";

        const box = document.createElement("div");
        box.className = `box ${v}`;
        box.style.setProperty("--c", h.color);
        box.title = `${h.name} • ${fmtUK(d)} • ${v.toUpperCase()}`;
        box.innerHTML = `<span class="label">${labels[i]}</span>`;
        box.addEventListener("click", () => cycle(h.id, iso));

        // Insert spacer before Fri so Fri starts row 2 col 1
        if (i === 4) {
          const spacer = document.createElement("div");
          spacer.className = "spacer";
          spacer.textContent = "";
          grid.appendChild(spacer);
        }

        grid.appendChild(box);
      }

      row.appendChild(left);
      row.appendChild(grid);
      list.appendChild(row);
    });
  }

  document.getElementById("addHabitBtn").onclick = () => {
    const i = document.getElementById("newHabitName");
    const name = (i.value || "").trim();
    if (!name) return;

    const newHabit = {
      id: makeId(),
      name,
      color: `hsl(${Math.random()*360} 80% 60%)`
    };

    data.habits.push(newHabit);
    data.entries[newHabit.id] = {};
    i.value = "";

    localStorage.setItem(STORAGE, JSON.stringify(data));
    render();
  };

  render();

  // Service worker (GitHub Pages path)
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/habits/sw.js?v=3");
  }
</script>
</body>
</html>
